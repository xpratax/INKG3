<!--n√£o a nada para besta ver no meu codigo fonteüñï  -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cact Ingressos</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    body {
        background: #111;
        color: #fff;
        font-family: Arial;
        padding: 20px;
    }
    .box {
        background: #1b1b1b;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 0 10px #000;
    }
    input, button, select {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border: none;
        border-radius: 8px;
    }
    button {
        background: #00ff88;
        color: #000;
        font-weight: bold;
        cursor: pointer;
    }
    button:hover {
        background: #00cc66;
    }
    .abaBtn {
        width: 32%;
        margin: 0.5%;
        display: inline-block;
        background: #333;
        color: #fff;
    }
    #politicasModal {
        display: none;
        background: rgba(0,0,0,0.85);
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        padding: 20px;
        overflow-y: auto;
    }
    #politicasContent {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 10px;
        max-width: 700px;
        margin: auto;
        margin-top: 40px;
    }
</style>
</head>

<body>

<h1>Cact Ingressos üéüÔ∏è</h1>
<p>Venda e compre ingressos com comiss√£o autom√°tica.</p>

<!-- POL√çTICAS -->
<div id="politicasBox" class="box" style="display:none;">
    <h2>Pol√≠ticas de Privacidade</h2>
    <p>Voc√™ precisa aceitar para continuar usando a plataforma.</p>
    <button onclick="abrirPoliticas()">Ler pol√≠ticas completas</button>
    <button onclick="aceitarPoliticas()">Aceitar ‚úî</button>
</div>

<div id="politicasModal">
    <div id="politicasContent">
        <h2>Pol√≠ticas de Privacidade</h2>
        <p>O sistema registra suas vendas, compras e comiss√µes.</p>
        <p>A comiss√£o N√ÉO √© permanente e pode ser removida a qualquer momento.</p>
        <button onclick="fecharPoliticas()">Fechar</button>
    </div>
</div>

<!-- LOGIN GOOGLE -->
<div id="loginBox" class="box" style="display:none;">
    <h2>Entrar</h2>
    <button onclick="loginGoogle()">Entrar com Google</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none;">

    <button class="abaBtn" onclick="abrirAba('abaCriar')">Criar Ingresso</button>
    <button class="abaBtn" onclick="abrirAba('abaComprar')">Comprar</button>
    <button class="abaBtn" onclick="abrirAba('abaMinhasVendas')">Minhas Vendas</button>

    <div id="abaCriar" class="box" style="display:none;">
        <h2>Criar Ingresso</h2>
        <input id="nomeIng" placeholder="Nome do ingresso">
        <input id="localIng" placeholder="Local">
        <input id="valorIng" type="number" placeholder="Valor">
        <input id="qtdIng" type="number" placeholder="Quantidade">
        <button onclick="criarIngresso()">Criar</button>
    </div>

    <div id="abaComprar" class="box" style="display:none;">
        <h2>Ingressos √† venda</h2>
        <div id="listaComprar">Carregando...</div>
    </div>

    <div id="abaMinhasVendas" class="box" style="display:none;">
        <h2>Minhas vendas</h2>
        <div id="listaVendas">Carregando...</div>
        <p><b>Total em comiss√£o:</b> <span id="comissaoTotal"></span></p>
    </div>

    <button style="margin-top:20px;" onclick="logout()">Sair</button>
</div>

<script>
/* ======================== */
/* SUPABASE CONFIG          */
/* ======================== */
const supabase = supabase.createClient(
    "https://nmbslklretjxqowhvotr.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuZG1vamRxcG5teGZhcG10eGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NzgxMjUsImV4cCI6MjA3OTI1NDEyNX0.HMZYxnIsUDC93qjdG0LKbZMT6w0g9DwJ1-tDEaaHNvc"
);

/* ======================== */
/* POL√çTICAS                */
/* ======================== */
function checkPoliticas() {
    if (!localStorage.getItem("politicasAceitas")) {
        politicasBox.style.display = "block";
        return false;
    }
    return true;
}
function aceitarPoliticas() {
    localStorage.setItem("politicasAceitas", "true");
    location.reload();
}
function abrirPoliticas(){ politicasModal.style.display="block"; }
function fecharPoliticas(){ politicasModal.style.display="none"; }

/* ======================== */
/* LOGIN GOOGLE             */
/* ======================== */
async function loginGoogle() {
    const { data, error } = await supabase.auth.signInWithOAuth({
        provider: "google"
    });
    if (error) alert(error.message);
}

async function logout() {
    await supabase.auth.signOut();
    location.reload();
}

/* ======================== */
/* ABAS                     */
/* ======================== */
function abrirAba(id) {
    abaCriar.style.display = "none";
    abaComprar.style.display = "none";
    abaMinhasVendas.style.display = "none";
    document.getElementById(id).style.display = "block";
}

/* ======================== */
/* CRIAR INGRESSO           */
/* ======================== */
async function criarIngresso() {
    const session = await supabase.auth.getSession();
    const uid = session.data.session.user.id;

    const nome = nomeIng.value;
    const local = localIng.value;
    const valor = Number(valorIng.value);
    const qtd = Number(qtdIng.value);

    await supabase.from("cact_ingressos").insert({
        user_id: uid,
        nome: nome,
        local: local,
        valor: valor,
        quantidade: qtd
    });

    alert("Ingresso criado!");
    carregarComprar();
}

/* ======================== */
/* COMPRAR INGRESSO         */
/* ======================== */
async function comprar(id, valor) {
    const session = await supabase.auth.getSession();
    const uid = session.data.session.user.id;

    const codigo = Math.random().toString(36).substring(2,10).toUpperCase();
    const comissao = valor * 0.10;

    await supabase.from("cact_vendas").insert({
        ingresso_id: id,
        comprador_id: uid,
        codigo: codigo,
        valor_pago: valor,
        comissao_valor: comissao
    });

    await supabase.rpc("reduzir_estoque", { ing_id: id });

    alert("Compra realizada! C√≥digo: " + codigo);
    carregarComprar();
}

/* ======================== */
/* LISTAR PARA COMPRA       */
/* ======================== */
async function carregarComprar() {
    const { data } = await supabase.from("cact_ingressos").select("*");

    let html = "";
    data.forEach(i=>{
        if(i.quantidade > 0){
            html += `
                <div class="box">
                    <b>${i.nome}</b><br>
                    Local: ${i.local}<br>
                    Valor: R$ ${i.valor}<br>
                    Estoque: ${i.quantidade}<br>
                    <button onclick="comprar('${i.id}', ${i.valor})">Comprar</button>
                </div>
            `;
        }
    });

    listaComprar.innerHTML = html || "Nenhum ingresso dispon√≠vel";
}

/* ======================== */
/* MINHAS VENDAS            */
/* ======================== */
async function carregarVendas() {
    const session = await supabase.auth.getSession();
    const uid = session.data.session.user.id;

    const { data } = await supabase
        .from("cact_vendas")
        .select("*, cact_ingressos(nome)")
        .eq("ingresso_id.user_id", uid);

    let total = 0;
    let html = "";

    data.forEach(v=>{
        total += v.comissao_valor;
        html += `
            <div class="box">
                <b>${v.cact_ingressos.nome}</b><br>
                C√≥digo: ${v.codigo}<br>
                Comiss√£o: R$ ${v.comissao_valor}
            </div>
        `;
    });

    listaVendas.innerHTML = html || "Nenhuma venda ainda";
    comissaoTotal.innerText = "R$ " + total.toFixed(2);
}

/* ======================== */
/* INICIALIZA√á√ÉO            */
/* ======================== */
window.onload = async () => {
    if (!checkPoliticas()) return;

    const session = await supabase.auth.getSession();

    if (!session.data.session) {
        loginBox.style.display = "block";
        return;
    }

    dashboard.style.display = "block";
    abrirAba("abaComprar");

    carregarComprar();
    carregarVendas();
};
</script>

</body>
</html>
